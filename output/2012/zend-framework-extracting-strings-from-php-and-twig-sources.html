<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Zend Framework: Extracting strings from PHP and Twig sources - bytespree.com</title>
    
    <meta name="description" content="How to implement custom mechanism of extracting translatable strings from your source code, since there is no standard way.">
    
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nanoc 3.4.3"> 

    <link rel="stylesheet" href="/assets/screen.css">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script>window.html5 || document.write('<script src="/assets/js/html5shiv.js"><\/script>')</script>
    <![endif]-->
  </head>
  <body>
    <div id="root">
      <div class="contentContainer">
        <header class="main">
          <ul>
            <li class="leader">
              <a href="/">Posts</a>
            </li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </header>
        
<article>
  <header>
    <h1>Zend Framework: Extracting strings from PHP and Twig sources</h1>
    <time datetime="2012-02-05" pubdate>
      February 05, 2012
    </time>
  </header>
  <p>In the last project I worked on, we used <code>Zend_Translate</code> with array adapter. There were three main problems with extracting translatable strings from sources:</p>

<ul>
<li>We were unable to use <a href="http://www.poedit.net/">Poedit</a>, because we didn&#39;t use Gettext adapter</li>
<li>All of our forms use default translator, so form definitions looks like this:</li>
</ul>
<pre class="highlight php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Application_Forms_Register</span> <span class="k">extends</span> <span class="nx">Zend_Form</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">init</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your name&#39;</span><span class="p">,</span> <span class="c1">// This needs to be extracted
</span>        <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;E-mail&#39;</span><span class="p">,</span> <span class="c1">// This too
</span>        <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">&#39;validators&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;EmailAddress&#39;</span><span class="p">),</span>
    <span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;submit&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">submit</span><span class="o">-&gt;</span><span class="na">setLabel</span><span class="p">(</span><span class="s1">&#39;Register&#39;</span><span class="p">);</span> <span class="c1">// And this
</span>  <span class="p">}</span>
<span class="p">}</span>
</pre>
<ul>
<li>Twig is used for templating, so we needed to extract translations from .twig files as well:</li>
</ul>
<pre class="highlight text">{{ t(&#39;Fill in the following form&#39;) }}
</pre>
<p>Note that we wrote custom extension for Twig, which provides <code>t</code> function for translation. Essentially, it just delegates calls to <code>Zend_Translate</code>.</p>

<p>Considering this, I decided to write a custom extractor. Since we have 2 main sources of translatable strings (Twig templates and PHP files), let&#39;s define common interface:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>

<span class="sd">/**
 * Common interface for different message extractors
 */</span>
<span class="k">interface</span> <span class="nx">ExtractorInterface</span>
<span class="p">{</span>
    <span class="sd">/**
     * Extracts messages from given resource. $resource is something that is
     * specific to message extractor, Twig extractor will treat it as a
     * template name, whereas for PHP it is a filename
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">extract</span><span class="p">(</span><span class="nv">$resource</span><span class="p">);</span>

    <span class="sd">/**
     * Sets a callback which will be called whenever a warning message is going
     * to be issued
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setWarningListener</span><span class="p">(</span><span class="nx">\Closure</span> <span class="nv">$listener</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>We&#39;ll call <code>extract</code> for given resource and it should return all translatable strings from it. <code>setWarningListener</code> allows setting custom callback which will be fired whenever something wrong happens during extracting. Let&#39;s start from Twig implementation:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>

<span class="sd">/**
 * Extracts messages from Twig templates
 */</span>
<span class="k">class</span> <span class="nc">TwigExtractor</span> <span class="k">extends</span> <span class="nx">AbstractExtractor</span> <span class="k">implements</span> <span class="nx">ExtractorInterface</span><span class="p">,</span> <span class="nx">\Twig_NodeVisitorInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$extracted</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">\Twig_Environment</span> <span class="nv">$env</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span> <span class="o">=</span> <span class="nv">$env</span><span class="p">;</span>
        <span class="c1">// Registers itself as a node visitor
</span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="o">-&gt;</span><span class="na">addNodeVisitor</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Defined by ExtractorInterface
     *
     * @param $resource Template name
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">extract</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="nv">$resource</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Parse template
</span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="o">-&gt;</span><span class="na">tokenize</span><span class="p">(</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="o">-&gt;</span><span class="na">getLoader</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getSource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span>
                    <span class="nv">$resource</span>
                <span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Twig_Error_Syntax</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span>
                <span class="s1">&#39;Twig has thrown syntax error &#39;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span>
                <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTemplateLine</span><span class="p">()</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Defined by Twig_NodeVisitorInterface
     *
     * Extracts messages from calls to the translate function.
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">enterNode</span><span class="p">(</span><span class="nx">\Twig_NodeInterface</span> <span class="nv">$node</span><span class="p">,</span> <span class="nx">\Twig_Environment</span> <span class="nv">$env</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">\Twig_Node_Expression_Function</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$args</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getNode</span><span class="p">(</span><span class="s1">&#39;arguments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getIterator</span><span class="p">();</span>
                <span class="nv">$lineno</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">&#39;Translate function requires at least one argument&#39;</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">\Twig_Node_Expression_Constant</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Singular translation
</span>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;lineno&#39;</span> <span class="o">=&gt;</span> <span class="nv">$lineno</span><span class="p">,</span>
                        <span class="p">);</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">\Twig_Node_Expression_Array</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Plural translation
</span>                        <span class="c1">// There must be at least three arguments
</span>                        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">&#39;Plural translation requires at least three elements&#39;</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                            <span class="nv">$elements</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getIterator</span><span class="p">();</span>
                            <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$elements</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">\Twig_Node_Expression_Constant</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                                    <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$elements</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">&#39;All elements of plural translation must be constant values&#39;</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">);</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                                    <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$messages</span><span class="p">,</span>
                                    <span class="s1">&#39;lineno&#39;</span> <span class="o">=&gt;</span> <span class="nv">$lineno</span><span class="p">,</span>
                                <span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">&#39;First argument of translate function must be either string or array&#39;</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Defined by Twig_NodeVisitorInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">leaveNode</span><span class="p">(</span><span class="nx">\Twig_NodeInterface</span> <span class="nv">$node</span><span class="p">,</span> <span class="nx">\Twig_Environment</span> <span class="nv">$env</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Defined by Twig_NodeVisitorInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPriority</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Twig allows you to write and register your custom node visitors. This is what we have done in the constructor. As you might know, after parsing template file, Twig creates a structure called &ldquo;abstract syntax tree&rdquo; - hierarchical tree of nodes. Each node represents something in template&#39;s source code: assignment, arithmetical expression or possibly an include statement. After parsing, Twig traverses this abstract tree of nodes, calling magic method for each of its registered visitors and passing current node as an argument. This method is defined by <code>Twig_NodeVisitorInterface</code> as <code>enterNode</code>. Among other types of nodes, there is a node called &ldquo;function expression&rdquo;, which is a target of our interest. If we encounter such node, we&#39;ll see whether its name equal to <code>t</code> (which is the translator function), and in such case, extract its arguments. There is one more thing: in case of plural translations <code>t</code> receives array of strings, not just one string. So there is an additional logic covering that case too.</p>

<p><code>AbstractExtractor</code>, which is extended by <code>TwigExtractor</code> provides some base methods like <code>warning</code> and is trivial to implement.</p>

<p>Now let&#39;s examine what we could do with PHP files. As there were a wrapper class around <code>Zend_Translate</code>, all of our translate calls looked like this:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Application\Translate\Translate</span> <span class="k">as</span> <span class="nx">t</span><span class="p">;</span>
<span class="c1">// ...
</span><span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="s1">&#39;Incoming messages&#39;</span><span class="p">);</span>
<span class="nv">$message</span> <span class="o">=</span> <span class="nx">t</span><span class="o">::</span><span class="na">t</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;You have %d message&#39;</span><span class="p">,</span> <span class="s1">&#39;You have %d messages&#39;</span><span class="p">),</span> <span class="nv">$c</span><span class="p">);</span>
</pre>
<p>Also, we needed to extract strings in forms <code>setLabel(something)</code> and <code>&#39;label&#39; =&gt; something</code>. Having armed with this information, I wrote a parser. Parser is a finite-state machine that receives a stream of PHP tokens. Here it is:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>
<span class="sd">/**
 * Extracts messages from PHP source files
 */</span>
<span class="k">class</span> <span class="nc">PhpExtractor</span> <span class="k">extends</span> <span class="nx">AbstractExtractor</span> <span class="k">implements</span> <span class="nx">ExtractorInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$extracted</span><span class="p">,</span> <span class="nv">$tokens</span><span class="p">,</span> <span class="nv">$state</span><span class="p">;</span>

    <span class="sd">/**
     * Defined by ExtractorInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">extract</span><span class="p">(</span><span class="nv">$resource</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="nv">$resource</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span> <span class="o">=</span> <span class="nb">token_get_all</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$resource</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tcount</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseTokens</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resource</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Skips all whitespaces (\n, \r, spaces, etc) starting from position $p.
     * @return position at which parsing could be continued.
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tcount</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">T_WHITESPACE</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$p</span><span class="o">++</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">ctype_space</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$p</span><span class="o">++</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$p</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Tries to parse &#39;t::t(&#39; tokens starting from position $p.
     * @return if successful, returns position at which parsing could be
     *  continued, false otherwise
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseTCall</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_STRING</span>
            <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_DOUBLE_COLON</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_STRING</span>
            <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Tries to parse &#39;array(&#39; tokens (keyword and opening parenthesis)
     * @return position at which parsing could be continued,
     *  false otherwise
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseArray</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_ARRAY</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Tries to parse array contents. Treats everything till &#39;)&#39;
     * separated by commas as array elements.
     * @return array with the following keys:
     *   &#39;pos&#39; =&gt; position at which parsing could be continued
     *   &#39;items&#39; =&gt; array elements
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseArrayContents</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tcount</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$items</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$items</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nv">$p</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span> <span class="o">=&gt;</span> <span class="nv">$p</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span> <span class="o">=&gt;</span> <span class="nv">$items</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Tries to parse &#39;&quot;label&quot; =&gt;&#39; tokens starting from position $p.
     * @return if successful, returns position at which parsing could be
     *  continued, false otherwise
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseLabelInArray</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evaluateString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;label&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_DOUBLE_ARROW</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Tries to parse &#39;-&gt;setLabel(&#39; tokens starting from position $p.
     * @return if successful, returns position at which parsing could be
     *  continued, false otherwise
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseSetLabelCall</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_OBJECT_OPERATOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">T_STRING</span>
            <span class="k">or</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;setLabel&#39;</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">isString</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">T_CONSTANT_ENCAPSED_STRING</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Finds line number for the token at position $p. If line number for this
     * token is unknown, it tries previous token
     * @return line number
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">lineno</span><span class="p">(</span><span class="nv">$p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$p</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nv">$p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Evaluates string token. Unquotes quoted string, strips backslashes.
     * @return string contents of the token
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">evaluateString</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$s</span> <span class="o">=</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$token</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$token</span><span class="p">;</span>
        <span class="nv">$s</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
        <span class="nv">$length</span> <span class="o">=</span> <span class="nb">mb_strlen</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
        <span class="nv">$last</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$first</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$last</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$s</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$first</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$last</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$s</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$s</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">protected</span> <span class="k">function</span> <span class="nf">parseTokens</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$state</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tcount</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$state</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                    <span class="c1">// Expecting one of the following:
</span>                    <span class="c1">// - function call t::t
</span>                    <span class="c1">// - label definition in array &#39;label&#39; =&gt; &#39;Your password&#39;
</span>                    <span class="c1">// - method call -&gt;setLabel
</span>                    <span class="k">if</span> <span class="p">((</span><span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseTCall</span><span class="p">(</span><span class="nv">$i</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">((</span><span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseLabelInArray</span><span class="p">(</span><span class="nv">$i</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">((</span><span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseSetLabelCall</span><span class="p">(</span><span class="nv">$i</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                    <span class="c1">// Expecting string or array keyword
</span>                    <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nv">$p</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseArray</span><span class="p">(</span><span class="nv">$i</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="c1">// Singular translation
</span>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evaluateString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$i</span><span class="p">]),</span>
                            <span class="s1">&#39;lineno&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">),</span>
                        <span class="p">);</span>
                        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span>
                            <span class="s1">&#39;First argument of translate function must be either string or array&#39;</span><span class="p">,</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span>
                        <span class="p">);</span>
                        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
                        <span class="nv">$state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
                    <span class="c1">// Expecting contents of array for plural translation
</span>                    <span class="nv">$array</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseArrayContents</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Plural translation requires at least three elements&#39;</span><span class="p">,</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span>
                        <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                        <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_slice</span><span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isString</span><span class="p">(</span><span class="nv">$item</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evaluateString</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span>
                                <span class="s1">&#39;All elements of plural translation must be constant values&#39;</span><span class="p">,</span>
                                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">)</span>
                            <span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                                <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$messages</span><span class="p">,</span>
                                <span class="s1">&#39;lineno&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">),</span>
                            <span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="nv">$state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
                    <span class="c1">// Expecting constant string (&#39;label&#39; =&gt; &#39;string&#39;)
</span>                    <span class="c1">// or setLabel(&#39;string&#39;)
</span>                    <span class="nv">$i</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">skipWhitespaces</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">extracted</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evaluateString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tokens</span><span class="p">[</span><span class="nv">$i</span><span class="p">]),</span>
                            <span class="s1">&#39;lineno&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">),</span>
                        <span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="s1">&#39;Label must be a constant string&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lineno</span><span class="p">(</span><span class="nv">$i</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
                    <span class="nv">$state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>As you can see, we used <a href="http://php.net/token_get_all"><code>token_get_all</code></a> to get stream of tokens from given file. Because we&#39;re skipping whitespaces where possible, this parser could handle these cases:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>
<span class="nx">t</span> <span class="o">::</span> <span class="na">t</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">);</span>
<span class="nx">t</span>
<span class="o">::</span>
  <span class="na">t</span><span class="p">(</span><span class="s1">&#39;def&#39;</span><span class="p">);</span>
<span class="k">array</span><span class="p">(</span><span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">);</span>
<span class="s1">&#39;label&#39;</span>
<span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span>
<span class="nv">$f</span><span class="o">-&gt;</span>
<span class="na">setLabel</span><span class="p">(</span><span class="s2">&quot;something&quot;</span><span class="p">)</span>
</pre>
<p>and so on.</p>

<p>Example usage:</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>
<span class="nv">$listener</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;Warning in %s at line %d: %s&#39;</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>
<span class="p">};</span>
<span class="nv">$extractor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PhpExtractor</span><span class="p">;</span>
<span class="nv">$extractor</span><span class="o">-&gt;</span><span class="na">setWarningListener</span><span class="p">(</span><span class="nv">$listener</span><span class="p">);</span>
<span class="c1">// Recursively loop over all PHP files under APPLICATION_PATH directory
</span><span class="nv">$dirIter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\RecursiveDirectoryIterator</span><span class="p">(</span><span class="nx">APPLICATION_PATH</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="k">new</span> <span class="nx">\RecursiveIteratorIterator</span><span class="p">(</span><span class="nv">$dirIter</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$filename</span> <span class="o">=&gt;</span> <span class="nv">$fileinfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$fileinfo</span><span class="o">-&gt;</span><span class="na">isFile</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fileinfo</span><span class="o">-&gt;</span><span class="na">getFilename</span><span class="p">(),</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;php&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result</span><span class="p">[</span><span class="nv">$filename</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$extractor</span><span class="o">-&gt;</span><span class="na">extract</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</pre>
<p>This is not the end, because you&#39;ll need to merge extracted messages into existing translations, delete outdated translations but that&#39;s another story.</p>

</article>


      </div>
      <div id="root_footer"></div>
    </div>

    <footer id="footer">
      <div class="contentContainer">
        <div>Copyright &copy; 2014 Galymzhan Kozhayev</div>
        <div>
          Find me on <a href="https://github.com/galymzhan">Github</a>, 
          <a href="https://twitter.com/justgalym">Twitter</a>
          and <a href="http://stackoverflow.com/users/450449/galymzhan">Stack Overflow</a>
        </div>
      </div>
    </footer>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29797407-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

  </body>
</html>
