<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Notes about Active Record in Yii framework - bytespree.com</title>
    
    <meta name="description" content="Some useful and good to know things I learned about Active Record in Yii.">
    
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nanoc 3.4.3"> 

    <link rel="stylesheet" href="/assets/screen.css">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script>window.html5 || document.write('<script src="/assets/js/html5shiv.js"><\/script>')</script>
    <![endif]-->
  </head>
  <body>
    <div id="root">
      <div class="contentContainer">
        <header class="main">
          <ul>
            <li class="leader">
              <a href="/">Words by <span class="author">galymzhan</span></a>
            </li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </header>
        
<article>
  <header>
    <h1>Notes about Active Record in Yii framework</h1>
    <time datetime="2013-01-06" pubdate>
      January 06, 2013
    </time>
  </header>
  <p><a href="http://www.yiiframework.com/">Yii</a> comes with a nice implementation of Martin
Fowler&#39;s Active Record pattern.  Being one of the major components of Yii
framework, it nicely handles validation, persistence and querying of the
objects stored in a database, so you can focus on the actual logic instead.
Here are some useful and good to know things for Yii programmers.</p>

<h2>It&#39;s a finder</h2>

<p>Instead of talking about CActiveRecord objects in general, let&#39;s take Post
class as an example of an AR model.</p>

<p>Besides representing your marvelous blog posts, each Post object also acts as
a finder of posts. When you call <code>Post::model()</code> you get a special instance of
<code>Post</code> which serves as a finder among other things. This is also highlighted in
the documentation:</p>

<blockquote>
<p>It is provided for invoking class-level methods (something similar to static
class methods.)</p>
</blockquote>

<p>It&#39;s explicitly stated that returned object should be used to invoke
class-level methods, or roughly speaking, methods which work on collections of
Post objects rather than one specific instance of Post.  All <code>find*</code> methods
are class-level methods because they operate on collection.</p>

<p>To act as a finder, all Post objects hold criteria object inside them &ndash;
instance of CDbCriteria. Let&#39;s call it <em>inner criteria</em> and that&#39;s what you
get when you call <code>$post-&gt;getDbCriteria()</code>. When you call various scopes
you&#39;re actually modifying inner criteria (that&#39;s why I like to think about
scopes as <em>criteria modifiers</em>). Relational query methods like <code>together</code> and
<code>with</code> also modify it. When we initially call <code>Post::model()</code>, inner criteria
is clean, that is, it does not have any SQL conditions applied. When we
further chain scopes like <code>Post::model()-&gt;published()-&gt;recent()</code> criteria gets
modified and remembers all query details like condition, ordering, limit,
joins, etc (provided we properly wrote these scopes). Finally, when we fire
off one of the <code>find*</code> or <code>count*</code> methods (these methods also can receive
additional criteria object which will be merged with the inner criteria), the
actual database query is performed and inner criteria is reset to clean state.
The last step is very important, because if criteria isn&#39;t reset, all
subsequent queries will still be using old criteria details.</p>

<p>So here comes the not so obvious part &ndash; this inner criteria is shared by ALL
finder instances of <code>Post</code>. Let&#39;s have a look at this example to understand
why it matters.</p>
<pre class="highlight php"><span class="c1">// Model: models/Post.php
</span><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">CActiveRecord</span> <span class="p">{</span>
  <span class="c1">// Scopes inside Post model
</span>  <span class="k">public</span> <span class="k">function</span> <span class="nf">scopes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;published&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;published = 1&#39;</span>
      <span class="p">),</span>
      <span class="s1">&#39;popular&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;published = 1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;order&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;view_count DESC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="p">}</span>

<span class="c1">// Controller: controllers/PostController.php
</span><span class="k">class</span> <span class="nc">PostController</span> <span class="k">extends</span> <span class="nx">CController</span> <span class="p">{</span>
  <span class="c1">// Show off posts
</span>  <span class="k">public</span> <span class="k">function</span> <span class="nf">actionIndex</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Show only published posts
</span>    <span class="nv">$dataProvider</span><span class="o">=</span><span class="k">new</span> <span class="nx">CActiveDataProvider</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">());</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;dataProvider&#39;</span><span class="o">=&gt;</span><span class="nv">$dataProvider</span><span class="p">,</span>
    <span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// View: views/post/index.php
</span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Posts</span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>

<span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">widget</span><span class="p">(</span><span class="s1">&#39;zii.widgets.CListView&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;dataProvider&#39;</span><span class="o">=&gt;</span><span class="nv">$dataProvider</span><span class="p">,</span>
  <span class="s1">&#39;itemView&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;_view&#39;</span><span class="p">,</span>
<span class="p">));</span>
<span class="cp">?&gt;</span>
</pre>
<p>So far everything is great. When we go to <code>/post/index</code> we see all published
blog posts. Now suppose we also want to show latest popular posts. Let&#39;s use
named scope <code>popular</code> for that. Our controller and view will be changed a bit.</p>
<pre class="highlight php"><span class="k">class</span> <span class="nc">PostController</span> <span class="k">extends</span> <span class="nx">CController</span> <span class="p">{</span>
  <span class="c1">// Show off posts
</span>  <span class="k">public</span> <span class="k">function</span> <span class="nf">actionIndex</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$dataProvider</span><span class="o">=</span><span class="k">new</span> <span class="nx">CActiveDataProvider</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">());</span>
    <span class="nv">$popular</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">popular</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span> <span class="c1">// &lt;-- this
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;dataProvider&#39;</span><span class="o">=&gt;</span><span class="nv">$dataProvider</span><span class="p">,</span>
      <span class="s1">&#39;popular&#39;</span> <span class="o">=&gt;</span> <span class="nv">$popular</span><span class="p">,</span>
    <span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// View
</span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Popular</span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
<span class="o">&lt;?</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$popular</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
  <span class="nt">&lt;li&gt;</span><span class="cp">&lt;?=</span> <span class="nx">CHtml</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="cp">&lt;?</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;h1&gt;</span>Posts<span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;?php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">widget</span><span class="p">(</span><span class="s1">&#39;zii.widgets.CListView&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;dataProvider&#39;</span><span class="o">=&gt;</span><span class="nv">$dataProvider</span><span class="p">,</span>
  <span class="s1">&#39;itemView&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;_view&#39;</span><span class="p">,</span>
<span class="p">));</span>
<span class="cp">?&gt;</span>
</pre>
<p>Now when we go the posts page, we suddenly see ALL posts under <strong>&ldquo;Posts&rdquo;</strong>
header, both published and not published. Seems like
<code>Post::model()-&gt;published()</code> isn&#39;t working when we pass it to the
<code>CActiveDataProvider</code>. Why? Remember that inner criteria object is shared
among all Post finders? When we pass <code>Post::model()-&gt;published()</code> to the
provider, the actual database query isn&#39;t performed, because <code>findAll</code> is NOT
called yet (it will be called when CListView inside the view gets rendered).
When we call <code>Post::model()-&gt;popular()-&gt;findAll()</code>, criteria object inside
Post is <em>reset</em>. So all Post finders, including the one which sits inside
provider, now have a clean criteria. When the CListView gets rendered, it&#39;s
too late, criteria is already clean, so the CActiveDataProvider fetches all
posts. To overcome this, we can either get popular posts before creating data
provider:</p>
<pre class="highlight php"><span class="nv">$popular</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">popular</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
<span class="nv">$dataProvider</span><span class="o">=</span><span class="k">new</span> <span class="nx">CActiveDataProvider</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">());</span>
</pre>
<p>or in case of some complicated scenario we can save and restore the inner
criteria:</p>
<pre class="highlight php"><span class="nv">$dataProvider</span><span class="o">=</span><span class="k">new</span> <span class="nx">CActiveDataProvider</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">());</span>
<span class="c1">// Save criteria
</span><span class="nv">$oldCriteria</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">();</span>
<span class="c1">// Do our work
</span><span class="nv">$popular</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">popular</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
<span class="c1">// Restore criteria
</span><span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setDbCriteria</span><span class="p">(</span><span class="nv">$oldCriteria</span><span class="p">);</span>
</pre>
<p>I took me some time to figure out what&#39;s happening when I first discovered it,
so you&#39;d better keep it in mind.  Now let&#39;s take a peek inside CActiveRecord
to understand why criteria it shared:</p>
<pre class="highlight php"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">model</span><span class="p">(</span><span class="nv">$className</span><span class="o">=</span><span class="nx">__CLASS__</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_models</span><span class="p">[</span><span class="nv">$className</span><span class="p">]))</span>
    <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_models</span><span class="p">[</span><span class="nv">$className</span><span class="p">];</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="nv">$model</span><span class="o">=</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_models</span><span class="p">[</span><span class="nv">$className</span><span class="p">]</span><span class="o">=</span><span class="k">new</span> <span class="nv">$className</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">_md</span><span class="o">=</span><span class="k">new</span> <span class="nx">CActiveRecordMetaData</span><span class="p">(</span><span class="nv">$model</span><span class="p">);</span>
    <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">attachBehaviors</span><span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">behaviors</span><span class="p">());</span>
    <span class="k">return</span> <span class="nv">$model</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Wow, actually the whole static model is cached in a static variable <code>$_models</code>
to make things faster, so that means we get the same instance when we call
<code>Post::model()</code>. Which of course implies that inner criteria will be the same
too.</p>

<h2>Searching models based on data inside related models</h2>

<p>Another thing I had some troubles with is getting related models and, at the
same time, using relational data to filter primary models. Scenario:</p>

<ol>
<li><strong>A</strong> (primary model) has many <strong>B</strong>-s</li>
<li>You want to search <strong>A</strong> and also fetch <strong>all</strong> of it&#39;s <strong>B</strong>-s using
<code>with</code> option</li>
<li>You want to select only some <strong>A</strong>-s based on data in <strong>B</strong></li>
</ol>

<p>To illustrate it, let&#39;s add tags to posts:</p>
<pre class="highlight php"><span class="k">class</span> <span class="nc">Post</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">relations</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">MANY_MANY</span><span class="p">,</span> <span class="s1">&#39;Tag&#39;</span><span class="p">,</span> <span class="s1">&#39;post_tag(post_id, tag_id)&#39;</span><span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>Note that we use additional table <code>post_tag</code> to store <code>MANY_MANY</code> relations.</p>

<p>In the post listing we show tags as links:</p>
<pre class="highlight php"><span class="o">&lt;</span><span class="nx">b</span><span class="o">&gt;</span><span class="nx">Tagged</span><span class="o">:&lt;/</span><span class="nx">b</span><span class="o">&gt;</span>
<span class="o">&lt;?</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nx">CHtml</span><span class="o">::</span><span class="na">link</span><span class="p">(</span><span class="nx">CHtml</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;post/index&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span> <span class="o">=&gt;</span> <span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">))</span> <span class="cp">?&gt;</span>,
<span class="cp">&lt;?</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
</pre>
<p>Now we should output posts for given tag when <code>/post/index?tag=tagname</code> is
requested. No problem, we already have a relation for that:</p>
<pre class="highlight php"><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;with&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tags.name = :tagName&#39;</span><span class="p">,</span>
        <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;:tagName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]),</span>
      <span class="p">),</span>
    <span class="p">),</span>
  <span class="p">));</span>
<span class="p">}</span>
</pre>
<p>This code correctly finds tagged posts, but has another problem &ndash; only the
requested tag is shown in a list of tags for all found posts. For example, if
we had visited <code>/post/index?tag=gaming</code> page, we&#39;d see only &ldquo;gaming&rdquo; in
&ldquo;Tagged:&rdquo; section of every post, even if they have more tags. This is correct
behavior, as we&#39;re explicitly restricting related tags to only those with
specified name. To get all related tags we can introduce an additional join to
filter posts:</p>
<pre class="highlight php"><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;with&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="c1">// or &#39;with&#39; =&gt; array(&#39;tags&#39; =&gt; array(&#39;together&#39; =&gt; false)),
</span>                    <span class="c1">// to load tags in a separate query
</span>
  <span class="c1">// Introducing manual join
</span>  <span class="s1">&#39;join&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;
    INNER JOIN post_tag pt ON pt.post_id = t.id
    INNER JOIN tag ON pt.tag_id = tag.id
  &#39;</span><span class="p">,</span>
  <span class="c1">// and specify criteria for the join
</span>  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tag.name = :tagName&#39;</span><span class="p">,</span>
  <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;:tagName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]),</span>
<span class="p">));</span>
</pre>
<p>Note that if you don&#39;t want to load related models, there is no need in an
additional join, just use the <code>select</code> option:</p>
<pre class="highlight php"><span class="c1">// We don&#39;t need to load tags
</span><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">published</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;with&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;select&#39;</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tags.name = :tagName&#39;</span><span class="p">,</span>
      <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;:tagName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]),</span>
    <span class="p">),</span>
  <span class="p">),</span>
<span class="p">));</span>
</pre>
<h2>Using scopes safely</h2>

<p>Scopes are great. They allow us to refactor monstrous <code>find*</code> invocations and
break them into simple, maintainable and reusable methods.</p>

<p>Since all AR query stuff eventually gets converted into SQL equivalent, most
errors arise from naming conflicts. We don&#39;t need to worry about it when
calling one of the AR query methods with additional criteria parameter, since
we see all table, column names and aliases right where the call happens. But
when writing scopes, we should take extra measures to prevent errors. This is
because we don&#39;t know in advance all the places where this scope is going to
be used, so we must ensure there isn&#39;t anything hardcoded.</p>

<h3>Quote table, alias and column names</h3>
<pre class="highlight php"><span class="c1">// Bad
</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;t.likes &gt; 10&#39;</span><span class="p">,</span>
<span class="p">));</span>

<span class="c1">// Good
</span><span class="nv">$db</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbConnection</span><span class="p">();</span>
<span class="nv">$alias</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTableAlias</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// Pass true to quote
</span><span class="nv">$column</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">quoteColumnName</span><span class="p">(</span><span class="s1">&#39;likes&#39;</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$alias</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nv">$column</span><span class="si">}</span><span class="s2"> &gt; 10&quot;</span><span class="p">,</span>
<span class="p">));</span>
</pre>
<h3>Table alias</h3>

<p>As noted in the documentation, table alias may vary in relational queries, so
we don&#39;t know it in advance. The good example is already shown above.</p>
<pre class="highlight php"><span class="c1">// Bad, does not use alias at all
</span><span class="nv">$column</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">quoteColumnName</span><span class="p">(</span><span class="s1">&#39;likes&#39;</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$column</span><span class="si">}</span><span class="s2"> &gt; 10&quot;</span><span class="p">,</span>
<span class="p">));</span>

<span class="c1">// Bad, hardcoded alias
</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;t.</span><span class="si">{</span><span class="nv">$column</span><span class="si">}</span><span class="s2"> &gt; 10&quot;</span><span class="p">,</span>
<span class="p">));</span>
</pre>
<h3>Table names</h3>

<p>If you&#39;ll ever need to know name of a table, all AR models define method
&ldquo;tableName&rdquo;.</p>
<pre class="highlight php"><span class="c1">// Bad
</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;join&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
<span class="p">));</span>

<span class="c1">// Good
</span><span class="nv">$db</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbConnection</span><span class="p">();</span>
<span class="nv">$table</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">quoteTableName</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">tableName</span><span class="p">());</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDbCriteria</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;join&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table</span><span class="p">,</span>
<span class="p">));</span>
</pre>
<h3>Use unique names for binding parameters</h3>

<p>We could have invented our own solution for this, but CDbCriteria already
provides static <code>$paramCount</code> property, which is used internally by framework
itself to generate unique parameter names.</p>
<pre class="highlight php"><span class="c1">// Bad, this fails if there is another binding called :param
</span><span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;t.id &gt; :param&quot;</span><span class="p">,</span>
  <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;:param&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">));</span>

<span class="c1">// Good
// By default it generates names like :ycp1
</span><span class="nv">$paramName</span> <span class="o">=</span> <span class="nx">CDbCriteria</span><span class="o">::</span><span class="na">PARAM_PREFIX</span> <span class="o">.</span> <span class="nx">CDbCriteria</span><span class="o">::</span><span class="nv">$paramCount</span><span class="o">++</span><span class="p">;</span>
<span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;condition&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;t.id &gt; </span><span class="si">{</span><span class="nv">$paramName</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
  <span class="s1">&#39;params&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$paramName</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">));</span>
</pre>
<h3>Merge default scopes of parent classes</h3>

<p>If both child and parent AR classes have defined defaultScope, do not try to
merge them with something like <code>array_merge</code>, use <code>CDbCriteria::mergeWith</code>
instead:</p>
<pre class="highlight php"><span class="k">public</span> <span class="k">function</span> <span class="nf">defaultScope</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CDbCriteria</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="c1">// Specify your default scope here
</span>  <span class="p">));</span>
  <span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">mergeWith</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="na">defaultScope</span><span class="p">());</span>
  <span class="k">return</span> <span class="nv">$criteria</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<h1>Also &hellip;</h1>

<p>You should be able to debug AR stuff by looking at generated SQLs. I use
CWebLogRoute to see all SQL queries at the bottom of a page, so I can quickly
search. If you can&#39;t find your query just use some unique alias or SQL comment
(like &ldquo;abracadabra&rdquo;) and search for that.</p>

<p>Of course we can fall back to SQL, but AR is much more convenient to use over
plain arrays, especially if models contain complicated business logic.
Also, some components like CActiveDataProvider work only with AR.</p>

</article>


      </div>
      <div id="root_footer"></div>
    </div>

    <footer id="footer">
      <div class="contentContainer">
        <div>Copyright &copy; 2013 Galymzhan Kozhayev</div>
        <div>
          Find me on <a href="https://github.com/galymzhan">Github</a>, 
          <a href="https://twitter.com/justgalym">Twitter</a>
          and <a href="http://stackoverflow.com/users/450449/galymzhan">Stack Overflow</a>
        </div>
      </div>
    </footer>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29797407-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

  </body>
</html>
